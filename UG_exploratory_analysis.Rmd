---
title: 'Urban Greenspaces: Exploratory Analysis'
author: "mm5951"
date: "`r Sys.Date()`"
output: html_document
---

**PENDING** : review which libraries to include.

```{r, include = FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
library(leaflet)
library(ggridges)

knitr::opts_chunk$set(
	echo = TRUE,
	warning = FALSE,
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%"
)
theme_set(theme_minimal() + theme(legend.position = "bottom"))
options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)
scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```

The primary goal of this exploratory data analysis (EDA) is to provide a primary dataset of NYC Urban Greenspaces upon which regression analysis can be conducted with potentially associated dimensions (temperature, econometrics, and health outcomes).

Secondly, this EDA aims to provide:

* a descriptive analysis of the NYC Urban Greenspaces primary dataset;
* relevant data visualizations of the above (notably including a map using the `leaflet` package and overtime trends);
* **TBD** a test of homogeneity to assess the distribution of Urban Greenspaces (UG) at the City Council District and Borough levels.


## Data load & wrangling

The primary Urban Greenspaces (UG) dataset is loaded ("UG_df_raw"). Next, `str()` and `skmir::skim()` functions are used to delve into the contents and structure of the resulting dataframe.

```{r, message = FALSE, warning = FALSE}
UG_df_raw = read_csv("./data/GreenRoofData2016_20180917.csv", na = c("","Unknown")) 

# Variables contained in the dataframe
str(UG_df_raw)

# Quick summary
skimr::skim(UG_df_raw)

# Looking into key variables
UG_df_raw %>%
  count(borough)

UG_df_raw %>%
  count(ownertype)
```

Additionally, a secondary dataset with the same variables aggregated by City Council Districts is loaded. Although not the main object of this EDA, it might be useful to conduct homogeneity test at such level.

```{r}
UG_agg_df= read_csv("./data/NYC_CounDist_GreenRoof_Bldg_MaxHVI_PctCSO.csv", na = c("","Unknown")) %>% 
  janitor::clean_names()

# Variables contained in the dataframe
str(UG_agg_df)

# Quick summary
skimr::skim(UG_agg_df)
```

Next, the "UG_df_raw" is wrangled in order to generate a "UG_df" dataframe to be used for analysis & association to other workstreams of the project:

* select relevant variables using `select()`
* rename certain variables for comprehension using `remame()`
* re-order the variables using `arrange()`
* drop entries with now total green area available using `drop_na()` 

**NOTE** consider removing "bin" and "bbl" if they are not needed to match with tax-related data.

```{r}
UG_df = UG_df_raw %>% 
  janitor::clean_names() %>% 
  select(fid:notes, address:ycoord, -doitt_id, -qa, -feat_code, -spdist1, -bbl_fixed) %>% 
  rename(
    UG_id = fid,
    latitude = ycoord,
    longitude = xcoord,
    cons_year = cnstrct_yr,
    green_area = gr_area,
    building_area = bldg_area
  ) %>% 
  mutate(
    perc_gr = prop_gr*100
  ) %>% 
  select(UG_id, cons_year, borough, zonedist1, address, ownertype, longitude, latitude, green_area, building_area, perc_gr,heightroof, groundelev, everything(), -prop_gr) %>% 
  drop_na(green_area)
```

Note that variable name and explanations are included in the "README_1.html" file, found inside the data folder of this project.

## Descriptive analysis

Next, a descriptive analysis of the "UG_df" dataframe is performed. 

Overall, the "UG_df" contains contains `r ncol(UG_df)` variables related to `r nrow(UG_df)` urban greenspaces in NYC. Details on the nature of its variables and summary values are found in the outputs above (chunk 1 of the data load & wrangling). 

The total UG area in NYC sums to `r sum(UG_df$green_area)` square feet. The following table summarizes the average urban greenspace in NYC, including its size (in square feet), height (in feet) and percentage of green coverage (that is, the proportion of green space within the total building area).

```{r}
UG_df %>% 
  summarize(
    mean_green = mean(green_area, na.rm = TRUE),
    mean_height = mean(heightroof, na.rm = TRUE),
    perc_gr = mean(perc_gr, na.rm = TRUE)
    ) %>% 
    knitr::kable(digits = 2)
```

When stratified by borough, differences in the amount of UGs as well as other the indicators used above become apparent. Key variables are summarized in the table below using `knitr:kable()`.

```{r}
UG_df %>% 
  group_by(borough) %>% 
  summarize(
    n = n(),
    tot_green = sum(green_area),
    mean_green = mean(green_area, na.rm = TRUE),
    mean_height = mean(heightroof, na.rm = TRUE),
    perc_gr = mean(perc_gr, na.rm = TRUE)
    ) %>% 
  arrange(desc(n)) %>% 
  knitr::kable(digits = 2)
```

## Data visualization

## Mapping UGs in NYC
Using the `leaflet` package to plot observations on a NY map. A `pal()` function is generated to establish a color according to the size of the UG.

```{r}
pal <- colorNumeric(
  palette = "viridis",
  domain = UG_df$green_area)

UG_map = UG_df %>% 
  mutate(
    round(green_area, digit = 2),
    round(heightroof, digit = 2),
    click_label = 
      str_c("<b>Area ", green_area, "sqft</b><br>Height ", heightroof, " ft<br>")) %>% 
  leaflet() %>% 
  addProviderTiles(providers$CartoDB.Positron) %>% 
  addCircleMarkers(~longitude, ~latitude, radius = .1, color = ~pal(green_area), popup = ~click_label)

UG_map
```

**Pending** : for some reason the `round()` is not working. Review it.

## UGs development overtime in NYC

Next, the construction of UG trends are investigated overtime. To do so, the `cumsum()` function is used over a generated dummy variable that allocated the value "1" to all UGs. Note that the observations with an invalid or missing construction year are ommited.

```{r}
UG_overtime = UG_df %>%
  drop_na(cons_year) %>% 
  filter(cons_year !=0) %>% 
  arrange(cons_year) %>% 
  mutate(
    cumsum_dummy = 1,
    cumulative_UG = cumsum(cumsum_dummy)
  )
  
UG_overtime %>% 
  group_by(borough) %>% 
  ggplot(aes(cons_year, cumulative_UG, color = borough)) +
  geom_point() +
  labs(
    title = "Overtime construction of Urban Greenspaces (UG)",
    x = "Time (year)",
    y = "Number of UG")
```

**Pending**: split into 5 differnt lines per borough, as example [here](https://stackoverflow.com/questions/66105937/time-series-cumulative-data-plots-using-ggplot2)


## Distribution of UG area by borough

Finally, the distribution of UG by borough is investigated. The "UG_df" is first plotted on a boxplot to have a better understanding of outliers. Given the presence of considerable outliers, the plotted green area surface is then limited to 67,000 sqft and visualized through a violin plot and a ridge plot.

**Pending** : decide which to keep.

```{r}
UG_dist = UG_df %>% 
  ggplot(aes(x = green_area, y = borough)) + 
  geom_boxplot() +
  labs(
    title = "Distribution of Urban Greenspaces (UG) surface by borough [boxplot]",
    x = "Green Area (sqft)",
    y = "Borough")

UG_dist

UG_df %>% 
  filter(green_area <67000) %>% 
  ggplot(aes(x = green_area, y = borough)) + 
  geom_density_ridges(scale = .85) +
  labs(
    title = "Distribution of Urban Greenspaces (UG) surface by borough [ggrides]",
    x = "Green Area (sqft)",
    y = "Borough")


UG_df %>% 
  filter(green_area <67000) %>% 
  ggplot(aes(x = green_area, y = borough)) + 
  geom_violin(aes(fill = borough), color = "blue", alpha = .5) +
  theme(legend.position = "bottom") +
  labs(
    title = "Distribution of Urban Greenspaces (UG) surface by borough [geom_violin]",
    x = "Green Area (sqft)",
    y = "Borough")
```

**Consider whether to include** no apparent association between UG area and building height.

```{r}
UG_df %>% 
  filter(green_area <67000) %>% 
  ggplot(aes(x = green_area, y = heightroof)) + 
  geom_point(aes(color = borough), alpha = .5) +
  labs(
    title = "Distribution of Urban Greenspaces (UG) surface by borough [ggrides]",
    x = "Green Area (sqft)",
    y = "Borough")
```


## **TBD** Test of homogeneity
To assess the distribution of Urban Greenspaces (UG) at the City Council District and Borough levels.
https://stats.oarc.ucla.edu/other/mult-pkg/whatstat/


## Acknowledgement

*The primary dataset was developed by The Nature Conservancy's New York City Program (Mike Treglia and Emily Maxwell) with contributions (data aggregation and additional support) from Timon McPhearson of The Urban Systems Lab at The New School, Eric Sanderson of The Wildlife Conservation Society, and Greg Yetman of CIESIN at Columbia University.*

Treglia, Michael L., McPhearson, Timon, Sanderson, Eric W., Yetman, Greg, & Maxwell, Emily Nobel. (2018). Green Roofs Footprints for New York City, Assembled from Available Data and Remote Sensing (Version 1.0.0) [Available here](https://github.com/tnc-ny-science/NYC_GreenRoofMapping/tree/master/greenroof_gisdata/CurrentDatasets). Zenodo. http://doi.org/10.5281/zenodo.1469674
