---
output: html_document
---

::: {align="center"}
# [Joint Analysis Dashboard]{style="color: red;"}
:::

```{r setup, include=FALSE}
library(tidyverse)
library(plotly)
library(zoo)
library(patchwork)
library(rvest)
library(httr)

knitr::opts_chunk$set(
	echo = TRUE,
	warning = FALSE,
  fig.width = 7,
  fig.asp = .6,
  out.width = "110%"
)
theme_set(theme_minimal() + theme(legend.position = "bottom"))
options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)
scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```

# Comparison of Asthma Rates with UGS

Next we will compare the UGS dataset with the asthma dataset, first visually and then also based on linear models.

We load and wrangle the **two primary Urban Green Spaces (UGS) dataset** to generate a **`UG_df` dataframe**, as well as the **asthma dataset** to generate a **asthma_df** dataframe, as described in the respective pages dedicated to the exploratory analysis of the datasets.

```{r, echo = FALSE, message=FALSE, warning = FALSE}
UG_df = read_csv("./data/GreenRoofData2016_20180917.csv", na = c("","Unknown")) %>% 
  janitor::clean_names() %>% 
  select(fid:notes, address:ycoord, -doitt_id, -qa, -feat_code, -spdist1, -bbl_fixed) %>% 
  rename(
    UG_id = fid,
    latitude = ycoord,
    longitude = xcoord,
    cons_year = cnstrct_yr,
    green_area = gr_area,
    building_area = bldg_area
  ) %>% 
  mutate(
    prop_gr = prop_gr*100,
    borough = recode(borough,
         BK = "Brooklyn",
         BX = "Bronx",
         MN = "Manhattan", 
         QN = "Queens",
         SI = "Staten Island"),
    ownertype = recode(ownertype,
         C = "Public",
         M = "Other",
         O = "Public", 
         P = "Private",
         X = "Other",
         P = "Private"),
    ownertype = replace_na(ownertype, "Private"),
    green_area = green_area*0.09290304,
    building_area = building_area*0.09290304,
    heightroof = heightroof*0.3048,
    groundelev = groundelev*0.3048
  ) %>% 
  select(UG_id, cons_year, borough, zonedist1, address, ownertype, longitude, latitude, green_area:groundelev, everything()) %>% 
  drop_na(green_area) 
```

```{r,  echo = FALSE, message=FALSE, warning = FALSE}
asthma_df = read_csv("./data/NYS_ASTHMA.csv", na = c("","Unknown")) %>% 
  janitor::clean_names() %>% 
  filter(county %in% c("Bronx", "Kings", "Queens", "New York County", "New York City", "Richmond")) %>%
  filter(year  %in% c("2005-2007", "2006-2008", "2007-2009", "2008-2010", "2009-2011", "2010-2012", "2011-2013", "2012-2014", "2013-2015", "2014-2016", "2015-2017", "2016-2018", "2017-2019")) %>% 
  select(-subgroup1, -subgroup_cat1:-subgroup_cat2, -c_rate10k:-c_rate10kpy, -aa_rate10k) %>% 
  rename(borough = county) %>% 
  mutate(
    borough = recode(borough,
                     "Kings" = "Brooklyn",
                     "New York County" = "Manhattan",
                     "Richmond" = "Staten Island"),
    year = recode(year,
                  "2005-2007" = 2006,
                  "2006-2008" = 2007, 
                  "2007-2009" = 2008, 
                  "2008-2010" = 2009, 
                  "2009-2011" = 2010, 
                  "2010-2012" = 2011, 
                  "2011-2013" = 2012, 
                  "2012-2014" = 2013, 
                  "2013-2015" = 2014, 
                  "2014-2016" = 2015, 
                  "2015-2017" = 2016, 
                  "2016-2018" = 2017, 
                  "2017-2019" = 2018))

asthma2_df = asthma_df %>% 
  select(-count, -daily_mean) %>% 
  pivot_wider(
    names_from = "indicator", 
    values_from = "aa_rate10kpy") %>% 
  janitor::clean_names() %>% 
  mutate(
    severity =  hospitalizations / ed_visits
  ) %>% 
  pivot_longer(
    ed_visits:severity,
    names_to = 'indicator',
    values_to = 'aa_rate10kpy') %>% 
  arrange(indicator)
```

Next, we create a value of green spaces that we can compare to asthma rates, namely the cumulative surface area of vertical greenspace that has been constructed between 2006-2018 in each borough.

```{r,  echo = FALSE, message=FALSE, warning = FALSE}
UG_df %>%
  drop_na(cons_year) %>% 
  filter(cons_year > 2005) %>% 
  arrange(borough, cons_year) %>% 
  select(cons_year, borough, green_area) %>% 
  group_by(borough, cons_year) %>% 
  summarize(
    green_area_sum = sum(green_area)) %>% 
  mutate(green_area_cum = cumsum(green_area_sum)) %>% 
  knitr::kable(digits = 2)

ug_bronx = UG_df %>%
  drop_na(cons_year) %>% 
  filter(cons_year > 2005) %>% 
  arrange(borough, cons_year) %>% 
  select(cons_year, borough, green_area) %>% 
  filter(borough == "Bronx") %>% 
  group_by(cons_year) %>% 
  summarize(
    green_area_sum = sum(green_area)) %>% 
  mutate(green_area_cum = cumsum(green_area_sum),
         borough = "Bronx") 

ug_brook = UG_df %>%
  drop_na(cons_year) %>% 
  filter(cons_year > 2005) %>% 
  arrange(borough, cons_year) %>% 
  select(cons_year, borough, green_area) %>% 
  filter(borough == "Brooklyn") %>% 
  group_by(cons_year) %>% 
  summarize(
    green_area_sum = sum(green_area)) %>% 
  mutate(green_area_cum = cumsum(green_area_sum),
         borough = "Brooklyn")

ug_manh = UG_df %>%
  drop_na(cons_year) %>% 
  filter(cons_year > 2005) %>% 
  arrange(borough, cons_year) %>% 
  select(cons_year, borough, green_area) %>% 
  filter(borough == "Manhattan") %>% 
  group_by(cons_year) %>% 
  summarize(
    green_area_sum = sum(green_area)) %>% 
  mutate(green_area_cum = cumsum(green_area_sum),
         borough = "Manhattan")

ug_queens = UG_df %>%
  drop_na(cons_year) %>% 
  filter(cons_year > 2005) %>% 
  arrange(borough, cons_year) %>% 
  select(cons_year, borough, green_area) %>% 
  filter(borough == "Queens") %>% 
  group_by(cons_year) %>% 
  summarize(
    green_area_sum = sum(green_area)) %>% 
  mutate(green_area_cum = cumsum(green_area_sum),
         borough = "Queens")
  
ug_tidy = bind_rows(ug_bronx, ug_brook, ug_manh, ug_queens) %>% 
  rename(year = cons_year) %>% 
  select(-green_area_sum)
```

#### Visualizations on UGS & Asthma Rates

We first visualize the result and compare it to the graph created on ED visits (taking that as a proxy for asthma rates). One trend is clear: while asthma rates seem to have declined, there seems to have been an increase in UGS. The patterns are not consistent across borough, e.g., there has been only gradual improvement in UGS in the Bronx, while the decline in asthma was more drastic. In short, there must surely be many other factors at play that have caused asthma rates to decline, but potentially UGS did play an effect in reducing the numbers.

```{r,  echo = FALSE, message=FALSE, warning = FALSE}
asthma_df = read.csv("./data/asthma_df.csv")
test_df = read.csv("./data/test_df.csv")
eitc_data = read.csv("./data/eitc_data.csv")

greenspace_df = test_df %>% 
  filter(indicator %in% ("ED Visits")) %>% 
  select(borough, year, green_area_cum) %>% 
  filter(borough %in% c("Bronx", "Brooklyn", "Queens", "Manhattan")) %>% 
  rename(tax_year = year) %>% 
  mutate(
    borough = as.factor(borough)
  )

tax_comp_df = eitc_data %>%
  filter(tax_year %in% (2006:2018)) %>%
  select(-boro_credit_total, -number_of_claims) %>% 
  arrange(borough, tax_year) %>%
  pivot_wider(
    names_from = credit_type,
    values_from = average_credit
  ) %>% 
  janitor::clean_names() %>% 
  mutate(
    eitc = city_eitc + state_eitc
  ) %>% 
  select(tax_year, borough, noncust_eitc, eitc) %>%
  group_by(tax_year, borough) %>% 
  filter(borough %in% c("Bronx", "Brooklyn", "Queens", "Manhattan")) %>% 
  mutate(
    tax_year = as.numeric(tax_year)
  )

greenspace_tax_comp = nyc_trend = left_join(tax_comp_df, greenspace_df, by = c("borough" = "borough", "tax_year" = "tax_year")) %>% 
  select(-c(noncust_eitc))

greenspace_time = greenspace_tax_comp %>%
  ggplot(aes(x = tax_year, y = green_area_cum, color = borough)) + 
  geom_point() + geom_line() +
  labs(
    x = "Year", 
    y = "Cummulative Greenspace (m^2)"
  )

ggplot_greenspace = ggplotly(greenspace_time) %>% 
  add_lines(name = "greenspace", legendgroup = "greenspace")

average_tax_time = greenspace_tax_comp %>%
  ggplot(aes(x = tax_year, y = eitc, color = borough)) + 
  geom_point() + geom_line() + 
  labs(
    x = "Year", 
    y = "Average EITC (dollars)", 
  ) 

ggplot_tax = ggplotly(average_tax_time) %>% 
  add_lines(name = "tax", legendgroup = "tax")

edvisits = asthma_df %>% 
  filter(indicator == "ED Visits", 
         borough != "Staten Island", 
         borough != "New York City") %>% 
  ggplot(aes(year, aa_rate10kpy, color = borough)) +
  geom_point() + geom_line() +
  labs(
    x = "Year",
    y = "Avg. ED visits per 10k inhabitants")

subplot(style(ggplot_greenspace, showlegend = FALSE),
        style(edvisits, showlegend = TRUE), 
        titleY = TRUE, 
        shareX = TRUE)
```


#### Regression Analysis of UGS and Asthma Rates

Let's run a couple of linear regression to see whether they produce any statistically significant results.

First, we are creating a combined df consisting of both UGS and asthma datasets by using a (double) leftjoin based on borough and year. We are using na.locf() to replace missing UGS values with the value from the last year (i.e, if there was a year with no greenspaces added, then that year must have had the same total number of greenspaces as the last year). Due to the way the dataframe is structured this requires a manual insertion of a value at two points of the dataset.  

```{r,  echo = FALSE, message=FALSE, warning = FALSE}
combined_df = left_join(asthma2_df, ug_tidy, by = c('year' = 'year', 'borough' = 'borough')) %>% 
  na.locf() %>% 
  filter(
    borough != "New York City",
    borough != "Staten Island")

combined_df$green_area_cum[14] = 6843.786
combined_df$green_area_cum[66] = 6843.786  
combined_df$green_area_cum[118] = 6843.786  
```

Let's run some regression! First I am creating separate dataframes for each indicator and set Manhattan as the comparator.

```{r,  echo = FALSE, message=FALSE, warning = FALSE}
combined_df_ed_lm = combined_df %>% 
  filter(indicator == "ed_visits") %>% 
  mutate(borough = forcats::fct_relevel(borough, c("Manhattan", "Bronx", "Brooklyn", "Queens")))

combined_df_hosp_lm = combined_df %>% 
  filter(indicator == "hospitalizations") %>% 
  mutate(borough = forcats::fct_relevel(borough, c("Manhattan", "Bronx", "Brooklyn", "Queens")))

combined_df_sev_lm = combined_df %>% 
  filter(indicator == "severity") %>% 
  mutate(borough = forcats::fct_relevel(borough, c("Manhattan", "Bronx", "Brooklyn", "Queens")))
```

Below tables show the results of linear regression of the indicator (either ED visit rate, Hospitalization rate or severity measure) on a combination of borough and total UGS surface area.

```{r,  echo = FALSE, message=FALSE, warning = FALSE}
fit4 = lm(aa_rate10kpy ~ green_area_cum + borough, data = combined_df_ed_lm)

fit4 %>% 
  broom::tidy() %>% 
  knitr::kable(digits = 3, align = "lcccc", caption = "Table 1: ED visit rate vs. borough and cumulative UGS surface area")
```

```{r,  echo = FALSE, message=FALSE, warning = FALSE}
fit5 = lm(aa_rate10kpy ~ green_area_cum + borough, data = combined_df_hosp_lm)

fit5 %>% 
  broom::tidy() %>% 
  knitr::kable(digits = 3, align = "lcccc", caption = "Table 2: Hospitalization rate vs. borough and cumulative UGS surface area")
```

```{r,  echo = FALSE, message=FALSE, warning = FALSE}
fit6 = lm(aa_rate10kpy ~ green_area_cum + borough, data = combined_df_sev_lm)

fit6 %>% 
  broom::tidy() %>% 
  knitr::kable(digits = 3, align = "lcccc", caption = "Table 3: Severity vs. borough and cumulative UGS surface area")
```

To our surprise, all three models return statistically significant values for the effect of cumulative UGS surface area on the studied indicators, while accounting for borough differences. The direction of the effect is how we would expect: increase in cumulative UGS surface area leads to a reduction in ED visit rate, hospitalization rate, and our severity measure! We conclude that urban green spaces might indeed have played a role in reducing asthma rates across New York City.


# Comparison of Earned Income Tax Credit (EITC) with UGS

When trying to find some association between greenspace data and average EITC tax credit amount, it's not possible to draw statistical conclusions with the information we have.  The data were collected with different methods and it would be wrong to do statistical comparisons.  That being said, we can create visualizations that give an overall idea of trends.  

Our hypothesis is that there will be more rooftop greenspaces present in boroughs where the average EITC credit amount is lower.  

To create this visualizations, we have to make a few assumptions. 

The `Greenspace` data does not specify when rooftop greenspaces were constructed.  We know that the data was collected between 2016-2018 and have information on when the building was constructed but that's all the detail we're given.  Meanwhile, EITC tax data for all EITC categories is accounted for from 2006 onward.  

We are going to assume that buildings constructed from 2006 onward were constructed initially with their rooftop greenspace.  Given the cost of construction and the logistics involved with residential building in New York City, we're assuming that developers did not retroactively add greenspace after initial construction of these modern buildings.  

We're also going to eliminate Staten Island from this visualization.  Staten Island doesn't have enough data on Greenspace to make it reasonable to include in a visualization. 

#### Visualizations on UGS & Asthma Rates

```{r, warning = FALSE, message = FALSE, echo = FALSE}

subplot(style(ggplot_greenspace, showlegend = FALSE), 
        style(ggplot_tax, showlegend = TRUE), 
        titleY = TRUE, 
        shareX = TRUE)
```

The visualization shows what we initially thought: Manhattan rooftop greenspace cumulative area has rapidly increased in the time frame while their average EITC credit amount has stayed the lowest of all the boroughs.  Meanwhile, the Bronx has consistently had the highest EITC credit amount while having a very low rate of increase in rooftop greenspace.  

Again, this is correlation, not causation but it does speak to the idea that rooftop greenspaces tend to appear in wealthier areas. 


#### Regression Analysis of UGS and EITC


```{r,  echo = FALSE, message=FALSE, warning = FALSE}
test_df = read.csv("./data/test_df.csv")

tax_data = 
  GET("https://data.ny.gov/resource/6q7b-8vuf.json", query = list("$limit" = 5000)) %>% 
  content("text") %>% 
  jsonlite::fromJSON() %>% 
  as_tibble()

eitc_data = tax_data %>%
  select(-c(notes, place_of_residence, place_of_residence_sort_order)) %>% 
  filter(county %in% c("Bronx", "Kings", "Manhattan", "Queens", "Richmond")) %>% 
  mutate(county = case_when(
    county == 'Kings' ~ 'Brooklyn', 
    county == 'Richmond' ~ 'Staten Island', 
    county == 'Bronx' ~ 'Bronx',
    county == 'Manhattan' ~ 'Manhattan',
    county == 'Queens' ~ 'Queens'
  )) %>% 
  mutate(credit_type = case_when(
    credit_type == 'NYC EITC' ~ 'City EITC',
    credit_type == 'NYS EITC' ~ 'State EITC',
    credit_type == 'NYS Noncustodial Parent EITC' ~ 'Noncust. EITC'
  )) %>% 
  mutate(
    credit_amount_claimed_in_thousands = as.numeric(credit_amount_claimed_in_thousands), 
    number_of_claims = as.numeric(number_of_claims),
    average_credit = as.numeric(average_credit)) %>% 
  mutate(credit_amount_claimed_in_thousands = credit_amount_claimed_in_thousands * 1000) %>% 
  rename(boro_credit_total = credit_amount_claimed_in_thousands, 
         borough = county) %>% 
  mutate(
    borough = as_factor(borough),
    borough = fct_relevel(borough , "Manhattan"))

write.csv(eitc_data, "./data/eitc_data.csv", row.names = FALSE)



greenspace_df = test_df %>% 
  filter(indicator %in% ("ED Visits")) %>% 
  filter(borough %in% c("Bronx", "Brooklyn", "Queens", "Manhattan")) %>% 
  rename(tax_year = year) %>% 
  mutate(
    borough = as.factor(borough)
  )

tax_comp_df = eitc_data %>%
  filter(tax_year %in% (2006:2018)) %>%
  select(-boro_credit_total, -number_of_claims) %>% 
  arrange(borough, tax_year) %>%
  pivot_wider(
    names_from = credit_type,
    values_from = average_credit
  ) %>% 
  janitor::clean_names() %>% 
  mutate(
    eitc = city_eitc + state_eitc
  ) %>% 
  select(tax_year, borough, noncust_eitc, eitc) %>%
  group_by(tax_year, borough) %>% 
  filter(borough %in% c("Bronx", "Brooklyn", "Queens", "Manhattan")) %>% 
  mutate(
    tax_year = as.numeric(tax_year)
  )

greenspace_tax_comp = nyc_trend = left_join(tax_comp_df, greenspace_df, by = c("borough" = "borough", "tax_year" = "tax_year")) %>% 
  select(-c(noncust_eitc)) %>% 
  rename(ed_visits = aa_rate10kpy) %>% 
  select(-c(indicator), -c(count), -c(daily_mean))

final_reg_df = greenspace_tax_comp

eitc_model = lm(green_area_cum ~ eitc + borough, data = final_reg_df)

eitc_model %>% 
  broom::tidy() %>% 
  knitr::kable(digits = 3, align = "lcccc", caption = "Regression Analysis of Tax and Borough on Cummulative Greenspace in New York City")
```


# Full Model: Regression
```{r, echo = FALSE}

full_model = lm(ed_visits ~ eitc + borough + green_area_cum + tax_year, data = final_reg_df)

full_model %>% 
  broom::tidy() %>% 
  knitr::kable(digits = 3, align = "lcccc", caption = "Regression Analysis of Tax, Cummulative Greenspace and Borough on Asthma in New York City")
  
```

The full regression model above uses ETIC, borough and cumulative green area as predictors of ED visits per 10,000 inhabitants.  The model shows statistically significant results for two boroughs: Bronx and Queens.  This is an effect we have already observed in univariate analysis of the asthma data set.  Unsurprisingly, the model did not yield statistically significant results for the effects of cumulative green space and tax on asthma rates.  However, the direction of the effect is as expected: the model does show lower asthma rates for higher cumulative greenspace. This effect was not statistically significant, however, the p value of 0.098 is moderately strong.  What is unexpected is the effect of tax on asthma rates: asthma rates decreases as EITC increases in this model.  We would have expected the opposite relationship, however the effect in this model was not statistically significant, with a p-value of 0.91. 

As already discussed, this was a hypothetical public health model that could have been applied in the real world.  Because of the limitations of our data (we had to make do with what we could source online) as well as the fact that asthma is a multifactorial diseases (meaning many factors contribute to it's development), this isn't a perfect representation of the real world.  

This project, however, has given us the opportunity to apply the tools and theories that we've learned this semester and that are very relevant to cutting-edge research within the public health world.  
