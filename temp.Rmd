---
title: "Temperature"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(janitor)
library(broom)
library(stringr)
library(leaflet)
library(leaflet.extras)

knitr::opts_chunk$set(
	echo = TRUE,
	warning = FALSE,
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%"
)
theme_set(theme_minimal() + theme(legend.position = "bottom"))
options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)
scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
knitr::opts_chunk$set(echo = TRUE)
```

## About the Dataset

This analysis includes datasets that were retrieved from the number of  [Climate Datasets](https://a816-dohbesp.nyc.gov/IndicatorPublic/beta/data-explorer/climate/?id=2141#display=summary) publicly available by NYC.gov. The datasets used are "Daytime Summer Surface Temperatures (째F)" and "Heat Vulnerability Index (NTA)". The NTA codes were used to merge the two datasets.

## Why Temperature?

It is hypothesized that urban green spaces are important in bringing down the air temperature in cities such as New York City. In this exploratory analysis, we will explore daytime surface temperatures and heat vulnerability index scores in New York City and the effect urban green spaces has on temperature and index scores. 

```{r, echo = FALSE, include = FALSE}
envo_health = read_csv("data/envo_health.csv") %>% 
  clean_names()

envo_health = 
  envo_health %>% 
  mutate(
    daytime_surface_temp = (daytime_surface_temp - 32)*.5556 
  )
```

# Summary Statistics

## Mean Surface Daytime Temperature by Borough
```{r, echo = FALSE}
envo_health %>% 
  group_by(borough) %>% 
  summarise(
    mean_daytime = mean(daytime_surface_temp)
  ) %>% 
  knitr::kable(digits = 3, align = "cc", caption = "Table 1: Mean Surface Daytime Temperature by Borough", col.names = c("Borough", "Mean Temperature (째C)"))
```

The daytime surface temperature was collected in Fahrenheit and varies based on vegetative covering and materials that retain heat, such as paved roads, sidewalks, and buildings. Neighborhoods with higher temperatures are seen to have more heat-exacerbated deaths associated with extreme heat events. In Table 1, there does not seem to much variability in the mean surface daytime temperature across the 5 boroughs. 

## Mean Heat Vulnerability Index by Borough
```{r, echo = FALSE}
envo_health %>% 
  group_by(borough) %>% 
  summarise(
    mean_daytime = mean(heat_vulnerability_index)
  ) %>% 
  knitr::kable(digits = 3, align = "cc", caption = "Table 2: Mean Heat Vulnerability Index by Borough", col.names = c("Borough", "Mean Heat Vulnerability Score"))
```
*Note: Score ranges from 1 (lowest risk) to 5 (highest risk), with low vulnerability at no risk of heat illness and death.*

In Table 2, Bronx has the highest mean heat vulnerability score (4.086), making it the borough with the high risk of heat illness and death. Staten Island has the lowest mean heat vulnerability score (1.526), with residents having little to no risk of heat illness and death. Bronx is known to have a large Black population and a larger proportion of individuals with lower income. 


# New York City Map
#### Daytime Surface Temperature and Heat Vulnerability Index by Location
```{r, echo = FALSE}
pal <- colorNumeric(
  palette = "viridis",
  domain = envo_health$daytime_surface_temp)
envo_map = envo_health %>% 
  mutate(
    daytime_surface_temp = round(daytime_surface_temp, digit = 2),
    click_label = 
      str_c("<b>Temperature (째C): ", daytime_surface_temp, " <br> Heat Vulnerability Score: ", heat_vulnerability_index, " <br> Neighborhood: ", neighborhood)) %>% 
    leaflet() %>% 
  addProviderTiles(providers$CartoDB.Positron) %>% 
  addCircleMarkers(lng = ~longitude, lat = ~latitude, radius = .1, color = ~pal(daytime_surface_temp), popup = ~click_label) %>% 
  setView(lng = -73.935242, lat = 40.730610, zoom = 11) %>% 
  addLegend("bottomright", pal = pal, values = ~daytime_surface_temp,
    title = "Temperature",
    labFormat = labelFormat(suffix = "째C"),
    opacity = 1
  )
  
envo_map
```

# Univariate Models

Two univariate, linear models were built to explore the association between:

  - boroughs and daytime surface temperature
  - boroughs and heat vulnerability index

Univariate models were because only one predictor was used. Linear models were used because the outcome variable, `daytime_surface_temp`, was continuous.

#### Borough and Daytime Surface Temperature  

In the summary statistics, the mean daytime surface temperature was not appreciably different across the boroughs. A linear model was used to further explore if there was a relationship between borough and daytime surface temperature.
```{r, echo = FALSE}
envo_health = 
  envo_health %>% 
  mutate(
    borough = fct_relevel(borough, "Manhattan"))

envo_surfmodel =
  lm(daytime_surface_temp ~ borough, data = envo_health) %>% 
  tidy() %>% 
  select(-statistic) %>% 
  mutate(
    low_conf = estimate - 1.96*std.error,
    upper_conf = estimate + 1.96*std.error) %>%  
  select(-std.error)

envo_surfmodel %>% 
  knitr::kable(digits = 3, align = "lcccc", caption = "Table 4: Coefficient Estimates of Linear Model Exploring Association of Borough and Daytime Surface Temperature", col.names = c("Term", "Estimate", "p-value", "Lower Confidence Interval", "Upper Confidence Interval"))
```


#### Borough and Heat Vulnerability Index

In the summary statistics, Bronx had the highest mean heat vulnerability score, which makes it the most at-risk borough in NYC to heat-related deaths. A linear model was used to further explore the relationship between borough and heat vulnerability index.

```{r, echo = FALSE}
envo_heatmodel =
  lm(heat_vulnerability_index ~ borough, data = envo_health) %>% 
  tidy() %>% 
  select(-statistic) %>% 
  mutate(
    low_conf = estimate - 1.96*std.error,
    upper_conf = estimate + 1.96*std.error) %>%  
  select(-std.error)

envo_heatmodel %>% 
  knitr::kable(digits = 3, align = "lcccc", caption = "Table 5: Coefficient Estimates of Linear Model Exploring Association of Borough and Heat Vulnerability Index", col.names = c("Term", "Estimate", "p-value", "Lower Confidence Interval", "Upper Confidence Interval"))
```


